<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="./assets/style.css">
	<script src="https://kit.fontawesome.com/e7df210b8c.js" crossorigin="anonymous"></script>
	<title>Student Sign Up</title>
	<style>
		* {
		  margin: 0;
		  padding: 0;
		  box-sizing: border-box;
		}

		body {
		  font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
		  background: var(--body);
		  min-height: 100vh;
		  display: flex;
		  flex-direction: column;
		}

		.form-container {
			margin-top: 120px;
		  flex: 1;
		  display: flex;
		  justify-content: center;
		  align-items: center;
		  padding: 2rem;
		}

		.form-wrapper {
		  background: white;
		  padding: 3rem;
		  border-radius: 12px;
		  box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
		  width: 100%;
		  max-width: 500px;
		}

		.form-wrapper h2 {
		  font-size: 2.5rem;
		  color: var(--logo);
		  text-align: center;
		  margin-bottom: 2rem;
		  font-weight: 600;
		}

		.form-group {
		  margin-bottom: 1.5rem;
		  display: flex;
		  flex-direction: column;
		}

		.form-group label {
		  font-size: 1.1rem;
		  color: #333;
		  margin-bottom: 0.5rem;
		  font-weight: 500;
		}

		.form-group input,
		.form-group select {
		  padding: 0.75rem 1rem;
		  font-size: 1rem;
		  border: 2px solid #e0e0e0;
		  border-radius: 6px;
		  transition: all 0.3s ease;
		  font-family: inherit;
		}

		.form-group select{
			height: 50px;
		}

		.form-group input:focus,
		.form-group select:focus {
		  outline: none;
		  border-color: var(--logo);
		  box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
		  background-color: #f8fbff;
		}

		.subjects-container {
		  display: grid;
		  grid-template-columns: 1fr 1fr;
		  gap: 0.75rem;
		  margin-top: 0.5rem;
		  padding: 1rem;
		  background-color: #f9f9f9;
		  border-radius: 6px;
		  border: 2px solid #e0e0e0;
		}

		.subject-checkbox {
		  display: flex;
		  align-items: center;
		  gap: 0.5rem;
		}

		.subject-checkbox input[type="checkbox"] {
		  width: 18px;
		  height: 18px;
		  cursor: pointer;
		  accent-color: var(--logo);
		}

		.subject-checkbox label {
		  margin: 0;
		  font-size: 0.95rem;
		  font-weight: normal;
		  cursor: pointer;
		}

		.error {
		  color: #c0392b;
		  font-size: 0.85rem;
		  margin-top: 0.3rem;
		  min-height: 1.2rem;
		}

		.success {
		  color: #27ae60;
		  font-size: 0.9rem;
		  margin-top: 0.3rem;
		}

		.checkbox-group {
		  flex-direction: row;
		  align-items: flex-start;
		  margin-bottom: 2rem;
		}

		.checkbox-label {
		  display: flex;
		  align-items: center;
		  gap: 0.75rem;
		  font-size: 1rem;
		  font-weight: normal;
		  cursor: pointer;
		}

		.checkbox-label input[type="checkbox"] {
		  width: 20px;
		  height: 20px;
		  cursor: pointer;
		  margin: 0;
		  padding: 0;
		}

		.checkbox-label a {
		  color: var(--logo);
		  text-decoration: none;
		  transition: color 0.3s ease;
		}

		.checkbox-label a:hover {
		  color: var(--logo);
		  text-decoration: underline;
		}

		.submit-btn {
		  width: 100%;
		  padding: 0.9rem 1.5rem;
		  font-size: 1.1rem;
		  background-color: var(--logo);
		  color: white;
		  border: none;
		  border-radius: 6px;
		  cursor: pointer;
		  font-weight: 600;
		  transition: all 0.3s ease;
		}

		.submit-btn:hover {
		  background-color: var(--logo);
		  transform: translateY(-2px);
		  box-shadow: 0 5px 15px rgba(0, 123, 255, 0.3);
		}

		.submit-btn:active {
		  transform: translateY(0);
		}

		.submit-btn:disabled {
		  background-color: #ccc;
		  cursor: not-allowed;
		  transform: none;
		}

		@media (max-width: 768px) {
		  .navbar {
		    flex-direction: column;
		    gap: 1rem;
		  }

		  .nav ul {
		    flex-wrap: wrap;
		    justify-content: center;
		    gap: 1rem;
		  }

		  .form-container {
		    padding: 1rem;
		  }

		  .form-wrapper {
		    padding: 2rem;
		  }

		  .form-wrapper h2 {
		    font-size: 2rem;
		  }

		  .form-group label {
		    font-size: 1rem;
		  }

		  .form-group input,
		  .form-group select {
		    font-size: 0.95rem;
		  }

		  .subjects-container {
		    grid-template-columns: 1fr;
		  }
		}

		@media (max-width: 480px) {
		  .form-wrapper {
		    padding: 1.5rem;
		  }

		  .form-wrapper h2 {
		    font-size: 1.75rem;
		    margin-bottom: 1.5rem;
		  }

		  .form-group {
		    margin-bottom: 1.2rem;
		  }

		  .form-group label {
		    font-size: 0.95rem;
		  }

		  .form-group input,
		  .form-group select {
		    font-size: 0.9rem;
		    padding: 0.65rem 0.85rem;
		  }

		  .submit-btn {
		    font-size: 1rem;
		    padding: 0.8rem 1rem;
		  }
		}
	</style>
</head>
<body>
	<nav class="navbar">
		<a href="index.html" class="Logo"><img src="./assets/images/pill-logo.png" alt="Logo" height="80px" width="auto"></a>
		<div class="nav">
			<ul class="list">
				<li><a href="aboutus.html" class="nb">About us</a></li>
				<li><a href="tutor.html" class="nb">Find a tutor</a></li>
				<li><a href="becomeTutor.html" class="nb">Become a tutor</a></li>
				<li><a href="login.html"><button type="button">Login</button></a></li>
				<li><a href="register.html"><button type="button">Sign in</button></a></li>
			</ul>
		</div>
	</nav>

	<div class="form-container">
		<div class="form-wrapper">
			<h2>Student Sign Up</h2>
			<form class="form" id="studentForm" novalidate>
				<div class="form-group">
					<label for="s-name">Full Name:</label>
					<input type="text" name="name" id="s-name" required>
					<div class="error" id="err-s-name"></div>
				</div>

				<div class="form-group">
					<label for="s-email">Email:</label>
					<input type="email" name="email" id="s-email" required>
					<div class="error" id="err-s-email"></div>
				</div>

				<div class="form-group">
					<label for="s-pass">Password:</label>
					<div class="password-wrapper">
						<input type="password" name="password" id="s-pass" required minlength="6">
						<button type="button" class="password-toggle" id="passwordToggle">
							<i class="fas fa-eye"></i>
						</button>
						
					</div>
					<div class="error" id="err-s-pass"></div>
				</div>

				<div class="form-group">
					<label for="s-level">Educational Level:</label>
					<select name="level" id="s-level" required>
						<option value="">Select level</option>
						<option value="Primary Class">Primary Class</option>
						<option value="Lower Secondary Class">Lower Secondary Class</option>
						<option value="+2">+2</option>
						<option value="Bachelors">Bachelors</option>
						<option value="Masters">Masters</option>
					</select>
					<div class="error" id="err-s-level"></div>
				</div>

				<div class="form-group">
					<label>Preferred Subjects (Select at least one):</label>
					<div class="subjects-container">
						<div class="subject-checkbox">
							<input type="checkbox" id="subj-math" name="subjects" value="Math">
							<label for="subj-math">Math</label>
						</div>
						<div class="subject-checkbox">
							<input type="checkbox" id="subj-physics" name="subjects" value="Physics">
							<label for="subj-physics">Physics</label>
						</div>
						<div class="subject-checkbox">
							<input type="checkbox" id="subj-english" name="subjects" value="English">
							<label for="subj-english">English</label>
						</div>
						<div class="subject-checkbox">
							<input type="checkbox" id="subj-cs" name="subjects" value="Computer Science">
							<label for="subj-cs">Computer Science</label>
						</div>
						<div class="subject-checkbox">
							<input type="checkbox" id="subj-chemistry" name="subjects" value="Chemistry">
							<label for="subj-chemistry">Chemistry</label>
						</div>
						<div class="subject-checkbox">
							<input type="checkbox" id="subj-biology" name="subjects" value="Biology">
							<label for="subj-biology">Biology</label>
						</div>
						<div class="subject-checkbox">
							<input type="checkbox" id="subj-nepali" name="subjects" value="Nepali">
							<label for="subj-nepali">Nepali</label>
						</div>
					</div>
					<div class="error" id="err-s-subject"></div>
				</div>

				<div class="form-group">
					<label for="s-mode">Mode:</label>
					<select name="mode" id="s-mode" required>
						<option value="">Select mode</option>
						<option value="Online">Online</option>
						<option value="Offline">Offline</option>
						<option value="Hybrid">Hybrid</option>
					</select>
					<div class="error" id="err-s-mode"></div>
				</div>

				<div class="form-group">
					<label for="s-location">Location (City):</label>
					<input type="text" name="location" id="s-location" required>
					<div class="error" id="err-s-location"></div>
				</div>

				<div class="form-group">
					<label for="s-budget">Budget (NPR/hr):</label>
					<input type="number" name="budget" id="s-budget" min="0" step="100" required>
					<div class="error" id="err-s-budget"></div>
				</div>

				<div class="form-group checkbox-group">
					<label for="s-terms" class="checkbox-label">
						<input type="checkbox" id="s-terms" required>
						<span>I agree to the <a href="terms.html" target="_blank">Terms and Conditions</a></span>
					</label>
					<div class="error" id="err-s-terms"></div>
				</div>

				<button type="submit" class="submit-btn" id="submitBtn">Create account</button>
				<div class="error" id="err-general"></div>
				<div class="success" id="success-msg"></div>
			</form>
		</div>
	</div>

	<script>
		(async () => {
		  const API_BASE_URL = 'http://localhost:5000/api';
		  
		  const passwordInput = document.getElementById('s-pass');
		  const passwordToggle = document.getElementById('passwordToggle');

		  passwordToggle.addEventListener('click', (e) => {
		    e.preventDefault();
		    const isPassword = passwordInput.type === 'password';
		    passwordInput.type = isPassword ? 'text' : 'password';
		    passwordToggle.innerHTML = isPassword ? '<i class="fas fa-eye-slash"></i>' : '<i class="fas fa-eye"></i>';
		  });
		  
		  function setError(id, msg) {
		    document.getElementById(id).textContent = msg || ""
		  }

		  function emailOk(v) {
		    return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(v)
		  }

		  document.getElementById("studentForm").addEventListener("submit", async (e) => {
		    e.preventDefault();
		    
		    let ok = true;
		    const submitBtn = document.getElementById("submitBtn");
		    
		    const name = document.getElementById("s-name").value.trim();
		    const email = document.getElementById("s-email").value.trim();
		    const pass = document.getElementById("s-pass").value;
		    const level = document.getElementById("s-level").value;
		    const mode = document.getElementById("s-mode").value;
		    const location = document.getElementById("s-location").value.trim();
		    const budget = document.getElementById("s-budget").value;
		    const terms = document.getElementById("s-terms").checked;
		    
		    const selectedSubjects = Array.from(document.querySelectorAll('input[name="subjects"]:checked')).map(cb => cb.value);

		    // Clear all errors
		    setError("err-s-name");
		    setError("err-s-email");
		    setError("err-s-pass");
		    setError("err-s-level");
		    setError("err-s-subject");
		    setError("err-s-mode");
		    setError("err-s-location");
		    setError("err-s-budget");
		    setError("err-s-terms");
		    setError("err-general");
		    setError("success-msg");

		    // Validation
		    if (name.length < 2) {
		      setError("err-s-name", "Please enter your full name.");
		      ok = false;
		    }
		    if (!emailOk(email)) {
		      setError("err-s-email", "Enter a valid email address.");
		      ok = false;
		    }
		    if (pass.length < 6) {
		      setError("err-s-pass", "Password must be at least 6 characters.");
		      ok = false;
		    }
		    if (!level) {
		      setError("err-s-level", "Select your level.");
		      ok = false;
		    }
		    if (selectedSubjects.length === 0) {
		      setError("err-s-subject", "Select at least one subject.");
		      ok = false;
		    }
		    if (!mode) {
		      setError("err-s-mode", "Select a mode.");
		      ok = false;
		    }
		    if (location.length < 2) {
		      setError("err-s-location", "Enter your city.");
		      ok = false;
		    }
		    if (budget === "" || Number(budget) < 0) {
		      setError("err-s-budget", "Enter a valid budget.");
		      ok = false;
		    }
		    if (!terms) {
		      setError("err-s-terms", "You must agree to the Terms and Conditions.");
		      ok = false;
		    }

		    if (!ok) return;

		    submitBtn.disabled = true;
		    submitBtn.textContent = "Creating account...";

		    let registerResult = null;
		    let userId = null;

		    try {
		      // Register user in user table
		      const registerData = {
		        full_name: name,
		        email: email,
		        password: pass,
		        role: 'student'
		      };

		      const registerResponse = await fetch(`${API_BASE_URL}/auth/register`, {
		        method: 'POST',
		        headers: {
		          'Content-Type': 'application/json'
		        },
		        body: JSON.stringify(registerData)
		      });

		      registerResult = await registerResponse.json();

		      if (!registerResponse.ok) {
		        throw new Error(registerResult.message || 'Registration failed');
		      }

		      userId = registerResult.user.user_id;
		      console.log("[v0] User registered successfully with ID:", userId);

		      const studentProfileData = {
		        user_id: userId,
		        academic_level: level,
		        preferred_subjects: selectedSubjects.join(','),
		        preferred_mode: mode.toLowerCase(),
		        budget: Number(budget),
		        availability: location
		      };

		      const profileResponse = await fetch(`${API_BASE_URL}/student/profile`, {
		        method: 'POST',
		        headers: {
		          'Content-Type': 'application/json'
		        },
		        body: JSON.stringify(studentProfileData)
		      });

		      if (!profileResponse.ok) {
		        const profileError = await profileResponse.json();
		        throw new Error(profileError.message || 'Profile creation failed');
		      }

		      console.log("[v0] Student profile created successfully");

		      localStorage.setItem('loggedIn', 'true');
		      localStorage.setItem('userRole', 'student');
		      localStorage.setItem('userId', userId);
		      localStorage.setItem('studentData', JSON.stringify({
		        user_id: userId,
		        full_name: name,
		        email: email,
		        role: 'student',
		        academic_level: level,
		        preferred_subjects: selectedSubjects,
		        preferred_mode: mode.toLowerCase(),
		        budget: Number(budget),
		        availability: location
		      }));

		      document.getElementById("success-msg").textContent = "Account created successfully! Redirecting...";
		      console.log("[v0] Redirecting to student-dashboard");
		      
		      setTimeout(() => {
		        window.location.href = 'student-dashboard.html';
		      }, 1500);

		    } catch (error) {
		      console.error("[v0] Error during signup:", error);
		      setError("err-general", error.message || "An error occurred during signup. Please try again.");
		      submitBtn.disabled = false;
		      submitBtn.textContent = "Create account";
		    }
		  });
		})();
	</script>
</body>
</html>
