<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="./assets/style.css">
	<title>Tutor Onboarding</title>
	<style>
		body {
			padding-top: 40px;
		}
		.quiz{max-width:860px;margin:20px auto;background:var(--nav);padding:24px;border-radius:16px;box-shadow:0 10px 10px 0 var(--shadow)}
		.quiz h2{margin-bottom:10px;color:var(--accent)}
		.timer{font-weight:700;color:var(--accent);margin-bottom:15px;font-size:1.1rem}
		.options{display:flex;flex-direction:column;gap:10px;margin:10px 0}
		.option{background:#fff;border:2px solid var(--accent);border-radius:10px;padding:10px;cursor:pointer;transition:all 0.3s ease}
		.option:hover{background:#f0f0f0;transform:translateY(-2px)}
		.option.selected{background:var(--logo);color:#fff;border-color:var(--logo)}
		.controls{display:flex;gap:12px;margin-top:10px}
		#question{font-size:1.2rem;font-weight:600;margin-bottom:15px}
	</style>
</head>
<body>

	<div class="quiz">
		<h2 id="quiz-title">Subject Quiz</h2>
		<div class="timer">Time left: <span id="time">150</span>s</div>
		<div id="question"></div>
		<div id="options" class="options"></div>
		<div class="controls">
			<button id="next" class="login">Next</button>
		</div>
	</div>

	<script>
	(function(){
		const API_BASE_URL = 'http://localhost:5000/api';
		var params = new URLSearchParams(window.location.search);
		var subject = params.get('subject') || 'Math';
		document.getElementById('quiz-title').textContent = subject + ' Quiz';

		var questions = [];
		const token = localStorage.getItem('authToken');
		if (!token) {
			alert('You must sign in first.');
			window.location.href = 'login.html';
			return;
		}
		fetch(`${API_BASE_URL}/test/quiz/${encodeURIComponent(subject)}`, {
			headers: { Authorization: `Bearer ${token}` }
		}).then(r=>r.json()).then(data=>{
			if (data && Array.isArray(data.questions)) {
				questions = data.questions;
				render();
				startTimer();
			} else {
				alert('No quiz available for this subject.');
			}
		}).catch(()=> alert('Failed to load quiz.'))

		var idx = 0, score = 0, totalTime = 150, remainingTime = 150, intervalId = null, selected = null;

		function render(){
			document.getElementById('question').textContent = (idx+1)+'. '+questions[idx].q;
			var opts = document.getElementById('options');
			opts.innerHTML = '';
			selected = null;
			questions[idx].a.forEach(function(txt,i){
				var div = document.createElement('div');
				div.className = 'option';
				div.textContent = txt;
				div.onclick = function(){ 
					selected = i;
					opts.querySelectorAll('.option').forEach(function(opt){ opt.classList.remove('selected'); });
					
					div.classList.add('selected');
				};
				opts.appendChild(div);
			});
		}

		function startTimer(){
			if(intervalId) clearInterval(intervalId);
			intervalId = setInterval(function(){
				remainingTime--; 
				document.getElementById('time').textContent = remainingTime;
				if(remainingTime<=0){ 
					clearInterval(intervalId);
					finish(); 
				}
			},1000);
		}

		function next(){
			if (selected != null) { if(!window._answers) window._answers = []; window._answers[idx] = selected; }
			idx++;
			if(idx>=questions.length){ 
				clearInterval(intervalId);
				finish(); 
				return; 
			}
			render();
		}

		function finish(){
			if(intervalId) clearInterval(intervalId);
			const answers = (window._answers || []).map(v=> (typeof v==='number'? v : -1));
			fetch(`${API_BASE_URL}/test/quiz/submit`, {
				method: 'POST',
				headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${token}` },
				body: JSON.stringify({ subject, answers })
			}).then(r=>r.json()).then(result=>{
				if(result.passed) {
					document.querySelector('.quiz').innerHTML = '<h2>ðŸŽ‰ Congratulations!</h2><p>You passed the quiz and verification has been granted.</p><p>Score: '+(result.score||0)+' / '+(result.total||questions.length)+'</p><a href="tutor-dashboard.html"><button class="login">Go to Dashboard</button></a>';
				} else {
					document.querySelector('.quiz').innerHTML = '<h2>ðŸ˜” Oops!</h2><p>You scored '+(result.score||0)+' / '+(result.total||questions.length)+'. You need at least 11 correct answers to pass.</p><p>Better luck next time!</p><a href="tutor-dashboard.html"><button class="login">Go to Dashboard</button></a>';
				}
			}).catch(()=>{
				document.querySelector('.quiz').innerHTML = '<h2>Quiz Completed</h2><p>Could not submit results. Please try again.</p><a href="tutor-dashboard.html"><button class="login">Go to Dashboard</button></a>';
			});
		}

		document.getElementById('next').onclick = next;
	})();
	</script>
</body>
</html> 