<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="./assets/style.css">
	<title>Tutor Onboarding</title>
	<style>
		.quiz{max-width:860px;margin:40px auto;background:var(--nav);padding:24px;border-radius:16px;box-shadow:0 10px 10px 0 var(--shadow)}
		.quiz h2{margin-bottom:10px}
		.timer{font-weight:700;color:var(--accent);margin-bottom:10px}
		.options{display:flex;flex-direction:column;gap:10px;margin:10px 0}
		.option{background:#fff;border:1px solid var(--accent);border-radius:10px;padding:10px;cursor:pointer}
		.controls{display:flex;gap:12px;margin-top:10px}
	</style>
</head>
<body>
	<nav class="navbar">
		<a href="index.html" class="Logo"><img src="./assets/images/pill-logo.png" alt="Logo" height="80px" width="auto"></a>
		<div class="nav">
			<ul class="list">
				<li><a href="aboutus.html" class="nb">About us</a></li>
				<li><a href="tutor.html" class="nb">Find a tutor</a></li>
				<li><a href="becomeTutor.html" class="nb">Become a tutor</a></li>
				<li><a href="login.html"><button type="button">Login</button></a></li>
				<li><a href="register.html"><button type="button">Sign up</button></a></li>
			</ul>
		</div>
	</nav>

	<div class="quiz">
		<h2 id="quiz-title">Subject Quiz</h2>
		<div class="timer">Time left: <span id="time">60</span>s</div>
		<div id="question"></div>
		<div id="options" class="options"></div>
		<div class="controls">
			<button id="next" class="login">Next</button>
		</div>
	</div>

	<script>
	(function(){
		const API_BASE_URL = 'http://localhost:5000/api';
		var params = new URLSearchParams(window.location.search);
		var subject = params.get('subject') || 'Math';
		document.getElementById('quiz-title').textContent = subject + ' Quiz';

		var questions = [];
		const token = localStorage.getItem('authToken');
		if (!token) {
			alert('You must sign in first.');
			window.location.href = 'login.html';
			return;
		}
		fetch(`${API_BASE_URL}/test/quiz/${encodeURIComponent(subject)}`, {
			headers: { Authorization: `Bearer ${token}` }
		}).then(r=>r.json()).then(data=>{
			if (data && Array.isArray(data.questions)) {
				questions = data.questions;
				render();
			} else {
				alert('No quiz available for this subject.');
			}
		}).catch(()=> alert('Failed to load quiz.'))

		var idx = 0, score = 0, timer = 60, intervalId = null, selected = null;

		function render(){
			document.getElementById('question').textContent = (idx+1)+'. '+questions[idx].q;
			var opts = document.getElementById('options');
			opts.innerHTML = '';
			selected = null;
			questions[idx].a.forEach(function(txt,i){
				var div = document.createElement('div');
				div.className = 'option';
				div.textContent = txt;
				div.onclick = function(){ selected = i; };
				opts.appendChild(div);
			});
			resetTimer();
		}

		function resetTimer(){
			if(intervalId) clearInterval(intervalId);
			timer = 60;
			document.getElementById('time').textContent = timer;
			intervalId = setInterval(function(){
				timer--; document.getElementById('time').textContent = timer;
				if(timer<=0){ next(); }
			},1000);
		}

		function next(){
			if(intervalId) clearInterval(intervalId);
			// server does grading; on client we just track selection index order
			if (selected != null) { if(!window._answers) window._answers = []; window._answers[idx] = selected; }
			idx++;
			if(idx>=questions.length){ finish(); return; }
			render();
		}

		function finish(){
			const answers = (window._answers || []).map(v=> (typeof v==='number'? v : -1));
			fetch(`${API_BASE_URL}/test/quiz/submit`, {
				method: 'POST',
				headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${token}` },
				body: JSON.stringify({ subject, answers })
			}).then(r=>r.json()).then(result=>{
				const msg = result.passed ? 'You passed! Verification granted.' : 'You did not reach 80%. Try again later.';
				document.querySelector('.quiz').innerHTML = '<h2>Quiz Completed</h2><p>'+msg+'</p><p>Score: '+(result.score||0)+' / '+(result.total||questions.length)+'</p><a href="tutor-dashboard.html"><button class="login">Continue</button></a>';
			}).catch(()=>{
				document.querySelector('.quiz').innerHTML = '<h2>Quiz Completed</h2><p>Could not submit results. Please try again.</p>';
			});
		}

		document.getElementById('next').onclick = next;
		// render will be called once quiz data loads
	})();
	</script>
</body>
</html> 